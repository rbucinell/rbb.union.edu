<!DOCTYPE html>
<html lang="en">
  <!--                                                                                                      -->
  <!-- Do not modify this file! It was automatically generated. To change it's content go to content folder -->
  <!--                                                                                                      -->
  <head>
    <title>Course Generator | Ronald B. Bucinell</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="Ryan Bucinell">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Ronald Bucinell's Professional Website">
    <meta name="keywords" content="factulty, professor, profile, ronlad bucinell, union, union college, mechanical, engineering, Course Generator">
    <meta property="og:site_name" content="rbb.union.edu">
    <meta property="og:title" content="Ronald B. Bucinell Ph.D., P.E">
    <meta property="og:description" content="Ronald B. Bucinell's Professional Website">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/img/portrait.jpg">
    <meta property="og:locale" content="en_US">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Ronald B. Bucinell Ph.D., P.E">
    <meta name="twitter:description" content="Ronald B. Bucinell's Professional Website">
    <meta name="twitter:image" content="/img/portrait.jpg">
    <meta name="twitter:image:alt" content="Ronald's Portrait">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/lib.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <script src="https://pugjs.org/js/pug.js"></script>
    <style>
      .modal-backdrop {
          display: none;
          z-index: 1040 !important;
      }
      
      .modal-content {
          margin: 2px auto;
          z-index: 1100 !important;
      }    
    </style>
  </head>
  <script src="https://pugjs.org/js/pug.js"></script>
  <style>
    .modal-backdrop {
        display: none;
        z-index: 1040 !important;
    }
    
    .modal-content {
        margin: 2px auto;
        z-index: 1100 !important;
    }    
  </style>
  <body class="d-flex flex-column vh-100 overflow-hidden">
    <div class="d-flex flex-column flex-sm-row overflow-auto h-100">
      <div class="row w-100">
        <aside class="g-0 col-sm-3 flex-shrink-1 sticky-top pb-sm-0 pb-3" id="nav-aside">
          <!--.p-1.h-100.sticky-top-->
          <div class="m-2" id="profile"><img class="img-thumbnail d-none d-sm-block" width="250px" height="250px">
            <div class="title text-center"><a href="/">
                <h4 class="pt-2">Ronald B. Bucinell, Ph.D., P.E.</h4></a>
              <h4 class="lead">Union College</h4>
            </div>
          </div>
          <nav class="navbar navbar-expand-sm d-flex flex-column">
            <button class="navbar-toggler mb-4 text-white" id="navtogglebutton" type="button" data-bs-toggle="collapse" data-bs-target=".navgroup"><i class="fa fa-bars"></i></button>
            <ul class="flex-fill align-self-start align-items-start navgroup navbar-collapse collapse navigation nav flex-column" id="mainNavigation"></ul>
            <ul class="flex-fill align-self-start align-items-start navgroup navbar-collapse collapse navigation nav flex-column mt-3" id="courseNameHeader">
              <li><span class="text-white px-2 lead font-weight-bold" id="courseNavName"></span></li>
            </ul>
            <ul class="flex-fill align-self-start align-items-start navgroup navbar-collapse collapse navigation nav flex-column" id="courseNavigation"></ul>
          </nav>
          <div class="social-icons">
            <div class="d-flex justify-content-center text-center"><span class="fs-3 flex-fill"><a title="Outlook Contact Card" href="/data/PE_Ronald_B_Bucinell_PhD.msg"><i class="fa-user fa"></i></a></span><span class="fs-3 flex-fill"><a title="LinkedIn Profile" href="https://www.linkedin.com/pub/ronald-bucinell/15/772/5a4"><i class="fa fa-linkedin"></i></a></span><span class="fs-3 flex-fill"><a title="Research Gate Profile" href="http://www.researchgate.net/profile/Ronald_Bucinell"><i class="ai ai-researchgate"></i></a></span><span class="fs-3 flex-fill"><a title="Phone Number" href="tel:+1518886023"><i class="fa fa-phone"></i></a></span><span class="fs-3 flex-fill"><a title="Email" href="mailto:bucinelr@union.edu"><i class="fa fa-envelope-o"></i></a></span></div>
          </div>
        </aside>
        <script>
          /**
          * @param {String} HTML representing a single element
          * @return {Element} a DOM element
          */
          function htmlToElement(html) {
              var template = document.createElement('template');
              html = html.trim(); // Never return a text node of whitespace as the result
              template.innerHTML = html;
              return template.content.firstChild;
          }
          
          async function loadXMLDoc(filename)
          {
              let response = await fetch(filename);
              let txt = await response.text();
              return [new DOMParser().parseFromString( txt, 'application/xml'), response.headers.get('Last-Modified')];
          }
          
          async function loadNavigation( filename, ulID )
          {
              let [xmlDoc, modified ] = await loadXMLDoc( filename );
              let ul = document.querySelector(`#${ulID}`);
              xmlDoc.querySelectorAll('item').forEach((item,i) =>
              {
                  let li = document.createElement('li');
                  let subitems = item.querySelectorAll('subitem');
                  if( subitems )
                  {
                      li.classList = 'nav-link px-2 text-wrap';
                      let menuName = item.getAttribute('name');
                      let anchor = htmlToElement(`<a id="${ulID}_menu${i}" class="text-white" data-bs-parent="#${ulID}" data-bs-toggle='collapse' data-bs-target='#${ulID}_submenu${i}' aria-expanded='false'>${menuName}</a>`);
                      let subul  = htmlToElement(`<ul id="${ulID}_submenu${i}" class="nav nav-pills flex-sm-column flex-row mb-auto justify-content-between text-truncate collapse" aria-labelledby="${ulID}_menu${i}"></ul>`);
                      
                      let expand = false;
                      //Add all the sub-menu items to sub-menu
                      item.querySelectorAll('subitem').forEach((sub,j)=>{
                          
                          let path = window.location.pathname.endsWith('/') ? 'index.html' : window.location.pathname;
                          if( path.includes(sub.getAttribute('target'))) expand = true;
          
                          let subli = document.createElement('li');
                          subli.classList = 'my-1 px-2 text-truncate text-muted';
                          let suba = htmlToElement(`<a class="text-white-50" href="${sub.getAttribute('target')}">${sub.getAttribute('name')}</a>`);
                          if( sub.getAttribute('external') )
                          {
                              suba.setAttribute('target', '_blank');
                              suba.appendChild(htmlToElement(`<i class="fa fa-external-link" style="padding-left:1rem;" aria-hidden="true"></i>`));
                          }
                          subli.appendChild(suba);
                          subul.append( subli );
                      });
                      if( expand && window.innerWidth >= 768) subul.classList.add('show');
                      li.appendChild(anchor);
                      li.appendChild(subul);
                  }
                  ul.append(li);
              });
          }
          
          document.addEventListener('DOMContentLoaded', async ()=> {
              if( '' )
              {
                  document.querySelector('#mainNavigation').appendChild(htmlToElement(`<li><a class="nav-link px-2 text-white" href="/index.html">Home</a></li>`));
                  await loadNavigation("/courses//content/data/nav.xml",'courseNavigation')
              }
              else 
              {
                  await loadNavigation( "/content/data/nav.xml", "mainNavigation");
              }
              document.querySelector('#mainNavigation').appendChild(htmlToElement(`<li><a class="nav-link px-2 text-white" href="/contact.html">Contact</a></li>`));
          });
        </script>
        <main class="col overflow-auto h-100" id="main">
          <header class="page-header sticky-top mt-4 mb-2">
            <h1 class="dislay-5" id="pageheader">Course Generator</h1>
            <ul class="breadcrumb bg-light p-2">
              <li class="breadcrumb-item">HIDDEN</li>
              <li class="breadcrumb-item active"><a href="#">Course Generator</a></li>
            </ul>
          </header>
          <div class="px-3">
            <section id="dadcontent"></section>
            <template id="sectionTemplate"> 
              <div class="section card mb-3 border border-secondary">
                <div class="card-header p-0">
                  <div class="input-group"><span class="input-group-text text-bold">
                      <h5 class="m-0">Section</h5></span>
                    <button class="btn btn-remove" type="button" onclick="removeSection(this)"><i class="fa fa-minus"></i></button>
                    <input class="form-control" id="sectionName" type="text" placeholder="Secion Name">
                    <button class="btn btn-add" id="addPageBtn" type="button" onclick="addPage(this)"><i class="fa fa-plus">&nbsp;Add Page</i></button>
                  </div>
                </div>
                <div class="card-body px-1"></div>
              </div>
            </template>
            <template id="pageTemplate">
              <div class="newpage">
                <div class="input-group mb-1"><span class="input-group-text">Page</span>
                  <input class="form-control" id="pageName" type="text" placeholder="Page Name" required>
                  <input class="form-control" id="pageURL" type="text" placeholder="Page URL (generator.html)" required>
                  <div class="input-group-text">
                    <label>External Link?
                      <input class="mx-1 form-check-input" id="externalLink" type="checkbox">
                    </label>
                  </div>
                  <button class="btn btn-remove" type="button" onclick="removePage(this)"><i class="fa fa-minus"></i></button>
                </div>
              </div>
            </template>
            <form class="form-inline" id="genratorForm">
              <div class="row">
                <h3>Course Info</h3>
              </div>
              <div class="row mb-3 form-group">
                <div class="col-xs-6 col-sm-3 col-md-2 form-group">
                  <label class="form-label" for="courseID">Course ID</label>
                  <input class="form-control" id="courseID" type="text" placeholder="e.g. ME100" required>
                </div>
                <div class="col-xs-6 col-sm-3 col-md-5 form-group"> 
                  <label class="form-label" for="courseName">Course Name</label>
                  <input class="form-control" id="courseName" type="text" placeholder="e.g. Introduction to Mechancis" required>
                </div>
                <div class="col-xs-6 col-sm-3 col-md-3 form-group pull-right">
                  <label class="form-label" for="navxmlpicker">Import <code>nav.xml</code>?</label>
                  <input class="form-control" id="navxmlpicker" type="file" onchange="importNavXML(event)">
                </div>
              </div>
              <div class="row">
                <h3>Rotation Images</h3>
              </div>
              <div class="row mb-3">
                <input id="rotateImages" type="file" name="rotateImages" multiple>
              </div>
              <div class="row mb-3">
                <h3>Sections
                  <button class="btn btn-add" id="addSectionButton" type="button" onclick="addSection()"><i class="fa fa-plus">&nbsp;Add Section</i></button>
                </h3>
              </div>
              <div class="row">
                <section id="sections"></section>
              </div>
              <div class="row">
                <section id="errors"></section>
              </div>
              <div class="row">
                <div class="col-2">
                  <button class="form-control btn btn-primary" type="post" onclick="generateButtonClick(event)">Generate</button>
                </div>
                <div class="col-2">
                  <button class="form-control btn btn-secondary" type="button" onclick="clearForm(event)">Clear Form</button>
                </div>
              </div>
            </form>
            <!-- Button trigger modal-->
            <button class="collapse btn btn-primary btn-lg" id="launchModal" type="button" data-bs-toggle="modal" data-bs-target="#createdModal">Launch modal</button>
            <!-- Modal-->
            <div class="modal fade" id="createdModal" tabindex="-1" aria-labelledby="myModalLabel" style="z-index: 9999">
              <div class="modal-dialog shadow-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">...</div>
                  <div class="modal-footer">
                    <button class="btn btn-default" type="button" data-bs-dismiss="modal">OK</button>
                  </div>
                </div>
              </div>
            </div>
            <section class="updated text-garnet fst-italic pull-right fw-light"></section>
          </div>
        </main>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script type="text/javascript" src="/js/lib.min.js"></script>
    <script type="text/javascript" src="/js/rbb.min.js"></script>
    <script>
      const event = new Event( 'DadContentLoaded' );
      /**
      * String helper function to see if input string 'str' ends with the string 'suffix'
      **/
      const endsWith = (str, suffix) => str.indexOf(suffix, str.length - suffix.length) !== -1;
      
      /**
      *   Function to format the html list after it is loaded
      **/
      function formatListGroup(headerText) {
          let listOfLI = [...document.querySelectorAll(`.list-group > li`)];
          console.log(listOfLI)
          listOfLI.forEach( n => n.classList +='list-group-item')
          document.querySelector( 'header > h1' ).innerText = `${headerText} (${listOfLI.length})`;
      }
      
      /**
      *  On DOM LOAD fetch the respective content file to populate the page
      **/
      document.addEventListener('DOMContentLoaded', async ()=> {
      
          let contentPath =  `content/${window.location.pathname.split('/').pop()}`;
          let response = await fetch(contentPath);
          if( response.status === 404)
          {
              response = await fetch(`/data/404.html`);
          }
          else {
              let updateDate = new Date(response.headers.get('Last-Modified')).toDateString();
              document.querySelector('.updated').innerText = `Updated: ${updateDate}`;
          }
          let data = await response.text();
          document.querySelector('#dadcontent').innerHTML = data;
          document.dispatchEvent( event );
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
      /**
      *   Reads the given nav.xml and imports it into the existing pages
      **/
      function importNavXML( event )
      {
          if(event.target.files.length === 0 ) return;
          let file = event.target.files[0];
          let reader = new FileReader();
          reader.onload = (e)=>{
              let data = e.target.result;
              let xml = new DOMParser().parseFromString( data, 'application/xml');
              document.querySelector('#sections').innerHTML = null;
              xml.querySelectorAll('item').forEach( (item,i) => {
                  addSection();
                  section = document.querySelector(`#sections .section:nth-child(${i+1})`);
                  section.querySelector('#sectionName').value = item.getAttribute('name');
                  section.querySelector('.card-body').innerHTML = null;
                  item.querySelectorAll( 'subitem' ).forEach( (si,j)=>{
                      addPage( section.querySelector('#addPageBtn') );
                      let page = section.querySelector(`.newpage:nth-child(${j+1})`);
                      page.querySelector('#pageName').value = si.getAttribute('name');
                      page.querySelector('#pageURL').value = si.getAttribute('target');
                      if( si.getAttribute('external') )
                          page.querySelector('#externalLink').checked = true;
                  });
              })
          }
          reader.readAsText(file);
      }
      
      /**
      *   fetches a pug template and returns its text content
      **/
      async function fetchTemplate( path )
      {
          return await fetch( path ).then( response => response.text() );
      }
      
      /**
      *   Removes the the button's parent, .section DOM element
      **/
      function removeSection( sectionBtn )
      {
          sectionBtn.closest('.section').parentElement.removeChild(sectionBtn.closest('.section'));
      }
      
      /**
      *   Adds a .section DOM element to the page
      **/
      function addSection()
      {
          let clone = document.querySelector('#sectionTemplate').content.cloneNode(true);
          let page = document.querySelector('#pageTemplate').content.cloneNode(true);
          clone.querySelector('.card-body').appendChild(page);
          document.querySelector('#sections').appendChild(clone);
          return clone;
      }
      
      /**
      *   Removes the the button's parent, .newpage DOM element
      **/
      function removePage( btn )
      {
          btn.closest('.newpage').parentElement.removeChild(btn.closest('.newpage'));
      }
      
      /**
      *   Adds a .newpage DOM element to the page
      **/
      function addPage( btn )
      {
          console.log( 'add apge!')
          let page = document.querySelector('#pageTemplate').content.cloneNode(true);
          let sectionBody = btn.closest('.section').querySelector('.card-body');
          sectionBody.appendChild(page);
      }
      
      function validateForm( manifestJSON )
      {
          //clear any old warnings
          let errors = document.querySelector('#errors');
          console.log( 'validateForm');
          errors.innerHTML = '';
          const alertElement = (title, msg ) =>
              errors.appendChild( htmlToElement(
                  `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                      <strong>${title}</strong>${msg}
                  </div>`));
          if(!manifestJSON.id) 
          {
              alertElement('Incomplete Form!', 'Missing Course ID');
              return false;
          }
          if(!manifestJSON.name) 
          {
              alertElement('Incomplete Form!', 'Missing Course Name');
              return false;
          }
          
          if( manifestJSON.sections.length === 0 )
          {
              alertElement('Incomplete Form!', 'No Sections Found');
              return false;
          }
      
          for( let section of manifestJSON.sections )
          {
              if(!section.name) 
              {
                  alertElement('Incomplete Form!', 'Section is missing a name');
                  return false;
              }
      
              if( section.pages.length === 0 )
              {
                  alertElement('Incomplete Form!', 'Section needs at least one page');
                  return false;
              }
      
              for( let page of section.pages )
              {
                  if(!page.name) 
                  {
                      alertElement('Incomplete Form!', `A page in section ${section.name} is missing a name`);
                      return false;
                  }
                  if(!page.url) 
                  {
                      alertElement('Incomplete Form!', `A page in section ${section.name} is missing an url`);
                      return false;
                  }
              }
          }
      
          return true;
      }
      
      const blobToData = (blob) => {
          return new Promise((resolve) => {
              const reader = new FileReader()
              reader.onloadend = () => resolve(reader.result)
              reader.readAsDataURL(blob)
          })
      }
      
      /**
      *   Generate button click handler. Creates files from the current DOM confuration on the page
      **/
      async function generateButtonClick(e)
      {
          e.preventDefault();
          let manifest = {
              id: document.querySelector('#courseID').value,
              name: document.querySelector('#courseName').value,
              created: (new Date()).toISOString(),
              sections: [],
              images: []
          }
      
          document.querySelectorAll('.section').forEach( section => {
              let newSection = {
                  name: '',
                  pages: []
              };
              newSection.name = section.querySelector('#sectionName').value;
      
              section.querySelectorAll('.newpage').forEach( page => {
                  let newPage = {
                      name: page.querySelector('#pageName').value,
                      url: page.querySelector('#pageURL').value,
                      externalLink: page.querySelector('#externalLink').checked
                  }
                  newSection.pages.push( newPage );
              })
              manifest.sections.push(newSection);
          });
      
          if( validateForm(manifest) )
              generateFiles( manifest );
      }
      
      async function generateFiles( manifestJSON )
      {
          let pageTemplate = await fetchTemplate( '/layouts/partials/page_template.pug' );
          pageTemplate = pageTemplate
              .replace('template_course', manifestJSON.id)
              .replace('template_courseName',   manifestJSON.name);
      
          let zip = new JSZip();
          const parser = new DOMParser();
          let xml  = parser.parseFromString('<?xml version="1.0" encoding="utf-8"?><navigation></navigation>', "application/xml");
          let root = xml.querySelector('navigation');
      
          //add pages, the respective content pages, and layouts
          for( let section of manifestJSON.sections ) {
              let template = pageTemplate.slice().replace('template_menu', section.name );
              let item = xml.createElement('item');
              item.setAttribute('name', section.name );
      
              for( let page of section.pages ) {
                  let subitem = xml.createElement('subitem');
                  subitem.setAttribute('name', page.name);
                  subitem.setAttribute('target', page.url);
                  if( !page.externalLink)
                  {
                      let layoutURL = page.url.substring( 0, page.url.lastIndexOf('.')) + '.pug';
                      //  zip.file( `${manifestJSON.id}/${page.url}`, '' );
                      zip.file( `${manifestJSON.id}/content/${page.url}`, `<div class="alert alert-warning" role="alert"><strong>Default File</strong><p>The content of this file (content/${page.url}) needs to be populated</p></div>` );
                      zip.file( `${manifestJSON.id}/layouts/${layoutURL}`, template.replace('template_name', page.name) );
                  }
                  else 
                  {
                      subitem.setAttribute('external', true);
                  }
                  item.appendChild(subitem);
              }
              root.appendChild(item);
          }
      
          //add images
          let imagePicker = document.querySelector('#rotateImages');
          for( let i = 0; i <imagePicker.files.length; i++ )
          {   
              let file = imagePicker.files[i];
              let ext = file.name.substring(file.name.lastIndexOf('.') + 1);
              let newName = `PIC${((i < 10 ) ? "0" + (i+1): i+1)}.${ext}`;
              manifestJSON.images.push( newName );
              zip.file(`${manifestJSON.id}/img/rotation/${newName}`, file);
          }
      
          //add the nav.xml
          zip.file(`${manifestJSON.id}/content/data/nav.xml`, new XMLSerializer().serializeToString(xml) );
          //add the manifest
          zip.file( `${manifestJSON.id}/manifest.json`, JSON.stringify(manifestJSON));
      
          let content = await zip.generateAsync( { type: 'blob'});
          saveAs(content, `${manifestJSON.id}.zip`);
      
          //Show Modal
          presentModal( manifestJSON );
      }
      
      function presentModal( manifestJSON )
      {
          let courseID = manifestJSON.id;
          let modal = document.querySelector('#createdModal');
          modal.querySelector('.modal-title').innerText = `${courseID}.zip Created!`;
          modal.querySelector('.modal-body').innerHTML = `
              A zip file has been downloaded with the contents required to setup a new course.
              <ul>
                  <li>The ${courseID} folder should be moved into your <code>./courses/</code> directory.
                  <li>Make sure you populate the files in the <code>content/</code>.</li>
                  <li>Give Ryan the zip file so he can update the site process the layouts for you</li>
              </ul>
      
              Don't forget to update the <code>./content/courselisting.html</code> page with the new link:
              <div class="well">
              &lt;li&gt;&lt;a href=&quot;courses/${courseID}/&quot;&gt;${manifestJSON.name}&lt;/a&gt;&lt;/li&gt;
              </div>
              `;
          document.querySelector('#launchModal').click();
      }
      
      function clearForm(event=null)
      {
          document.querySelector('#courseID').value = '';
          document.querySelector('#courseName').value = '';
          document.querySelector('#navxmlpicker').value = ''; //clear file caching
          document.querySelector('#sections').innerHTML = '';
          document.querySelector('#addSectionButton').click();
      }
      
      document.addEventListener('DadContentLoaded', ()=>{
          document.querySelector("#dadcontent").innerHTML = "";
          document.querySelector('.updated').innerHTML = '';
          clearForm();
      });
    </script>
  </body>
</html>